#include <iostream>
#include <cstdint>
#include <vector>
#include "test.hpp"
#include "core.hpp"
#include <cstring>

bool TestSalsa20_8 () {
    uint32_t test_array[16] = {0x219a877e, 0x86c93e4f, 0xe640a97c, 0x268f7141, 0x5b55eeba, 0xb5c1618c, 0x1146f80d, 0x1d3bcd6d, 0x19f324ee, 0x853d9bdf, 0x4b1e1214, 0x32aac55a, 0x291d0276, 0x2948c709, 0x8dc6ebed, 0x5ec2b8b8};
    uint32_t test_array_output[16] = {0x9c851fa4, 0x99cc0866, 0xcbca813b, 0x5ef0c02, 0x81214b04, 0x7d33fda2, 0x631c7bfd, 0x292f6896, 0x683139b4, 0xbce6c9e3, 0xb7c56bfe, 0xba966da0, 0x10cc24e4, 0x5c74912c, 0x3d67ad24, 0x818f61c7};
    std::vector<uint32_t> test_vector(test_array, test_array + 16);
    test_vector = Salsa20_8(test_vector);
    for (int i =0; i < 16; ++i) {
        if (test_vector[i] != test_array_output[i]) return false;
    }
    return true;
}

bool TestScryptBlockMix () {
    int r = 1;
    uint32_t test_array[2*r][16] = {{0x650bcef7, 0xa4722d3d, 0xabf58c10, 0xddff12e9, 0xdb167677, 0xea727bb, 0xaef30482, 0xad6f0f2d, 0x488ff689, 0x7be8d111, 0x40d73bcc, 0x29fd9f0a, 0x84014f09, 0xf3749563, 0x31a1e59a, 0xd7bc1752},
                                    {0x44914989, 0x22bb1372, 0x4db5256c, 0xfb7063a8, 0x804398cd, 0xbb664637, 0xbfb5fc8f, 0xb054c240, 0x517cd267, 0xfed54ace, 0xbc929d8, 0x1b575a50, 0xad1c4d7f, 0xda3c526a, 0xbc670e77, 0x897eafea}};
    uint32_t test_array_output[2*r][16] = {{0x9c851fa4, 0x99cc0866, 0xcbca813b, 0x5ef0c02, 0x81214b04, 0x7d33fda2, 0x631c7bfd, 0x292f6896, 0x683139b4, 0xbce6c9e3, 0xb7c56bfe, 0xba966da0, 0x10cc24e4, 0x5c74912c, 0x3d67ad24, 0x818f61c7},
                                            {0x75c9ed20, 0xa8813832, 0x4cf64005, 0x3ccd2d16, 0xfe7c0721, 0xe25f8d5f, 0x8f16a4b1, 0xb7783695, 0x803d3b7d, 0xabe4603b, 0xe5960992, 0xb6534d9b, 0x58222a5d, 0xf5edd577, 0xf1b92c84, 0x25e4ef4e}};

    std::vector<std::vector<uint32_t>> test_vector;
    std::vector<uint32_t> part1(test_array[0], test_array[0] + 16);
    std::vector<uint32_t> part2(test_array[1], test_array[1] + 16);
    test_vector.push_back(part1);
    test_vector.push_back(part2);

    test_vector = ScryptBlockMix(test_vector, r);
    for (int j = 0; j < r; ++j) {
        for (int i =0; i < 16; ++i) {
            if (test_vector[j][i] != test_array_output[j][i]) {
                std::cout << std::hex << test_vector[j][i] << " " << std::hex << test_array_output[j][i] << std::endl;
                return false;
            }
        }
    }
    return true;
}

/**
 * TestScryptROMix
 * 
 * vecteurs de tests venant de: https://www.ietf.org/rfc/rfc7914.html#page-11
 */
bool TestScryptROMix () {
    int r = 1;
    uint32_t N = 16;
    uint32_t test_array[2*r][16] = {{0x650bcef7, 0xa4722d3d, 0xabf58c10, 0xddff12e9, 0xdb167677, 0xea727bb, 0xaef30482, 0xad6f0f2d, 0x488ff689, 0x7be8d111, 0x40d73bcc, 0x29fd9f0a, 0x84014f09, 0xf3749563, 0x31a1e59a, 0xd7bc1752},
                                    {0x44914989, 0x22bb1372, 0x4db5256c, 0xfb7063a8, 0x804398cd, 0xbb664637, 0xbfb5fc8f, 0xb054c240, 0x517cd267, 0xfed54ace, 0xbc929d8, 0x1b575a50, 0xad1c4d7f, 0xda3c526a, 0xbc670e77, 0x897eafea}};
    uint32_t test_array_output[2*r][16] = {{0x93c1cc79, 0xcaeb9d62, 0x700b7f04, 0xb6f64b60, 0x4adde32c, 0x55e32696, 0x9861fcfa, 0x462beae6, 0x671384d5, 0x29b0993b, 0x57c365d6, 0x26b41f60, 0xbbf4b2a0, 0x9fee00a2, 0x9bd1430a, 0x719c1a57},
                                            {0xe64211ef, 0x6f265a5d, 0x2c83cadd, 0x7caa9fe5, 0xf19c0bac, 0xcaff2bbe, 0xee010d30, 0xc4197638, 0x44fd12ae, 0xa003f238, 0x7ec4e1e4, 0x1f8614c3, 0xcb87904e, 0x686a3933, 0xd2f9e873, 0x8e4b9a53}};
    std::vector<std::vector<uint32_t>> test_vector;
    std::vector<uint32_t> part1(test_array[0], test_array[0] + 16);
    std::vector<uint32_t> part2(test_array[1], test_array[1] + 16);
    test_vector.push_back(part1);
    test_vector.push_back(part2);

    std::vector<std::vector<uint32_t>> test_vector_output = ScryptROMix(test_vector, r, N);
    for (int j = 0; j < r; ++j) {
        for (int i =0; i < 16; ++i) {
            if (test_vector_output[j][i] != test_array_output[j][i]) {
                std::cout << std::hex << test_vector_output[j][i] << " " << std::hex << test_array_output[j][i] << std::endl;
                return false;
            }
        }
    }
    return true;
}

bool TestScrypt () {
    // const char salt[5] = "NaCl";
    // const char password[9] = "password";

    const char *password[] = {
        (const char[1]){},
        (const char[9]){'p', 'a', 's', 's', 'w', 'o', 'r', 'd'},
        (const char[9]){'p', 'a', 's', 's', 'w', 'o', 'r', 'd'},
        (const char[14]){'p', 'l', 'e', 'a', 's', 'e', 'l', 'e', 't', 'm', 'e', 'i', 'n'}, 
        (const char[14]){'p', 'l', 'e', 'a', 's', 'e', 'l', 'e', 't', 'm', 'e', 'i', 'n'},
    };
    const char *salt[] = {
        (const char[1]){},
        (const char[5]){'N', 'a', 'C', 'l'},
        (const char[5]){'N', 'a', 'C', 'l'},
        (const char[15]){'S', 'o', 'd', 'i', 'u', 'm', 'C', 'h', 'l', 'o', 'r', 'i', 'd', 'e'},
        (const char[15]){'S', 'o', 'd', 'i', 'u', 'm', 'C', 'h', 'l', 'o', 'r', 'i', 'd', 'e'},
    };


    uint32_t N[5] = {16, 4096, 1024, 16384, 1048576};
    int r[5] = {1, 8, 8, 8, 8};
    int p[5] = {1, 2, 16, 1, 1};
    int cLen = 64;

    uint8_t correct_output[5][cLen] = {{0x77, 0xd6, 0x57, 0x62, 0x38, 0x65, 0x7b, 0x20, 0x3b, 0x19, 0xca, 0x42, 0xc1, 0x8a, 0x04, 0x97, 0xf1, 0x6b, 0x48, 0x44, 0xe3, 0x07, 0x4a, 0xe8, 0xdf, 0xdf, 0xfa, 0x3f, 0xed, 0xe2, 0x14, 0x42, 0xfc, 0xd0, 0x06, 0x9d, 0xed, 0x09, 0x48, 0xf8, 0x32, 0x6a, 0x75, 0x3a, 0x0f, 0xc8, 0x1f, 0x17, 0xe8, 0xd3, 0xe0, 0xfb, 0x2e, 0x0d, 0x36, 0x28, 0xcf, 0x35, 0xe2, 0x0c, 0x38, 0xd1, 0x89, 0x06},
        {0xed, 0xf8, 0x2d, 0xcd, 0x10, 0x6e, 0x1f, 0x9e, 0xd1, 0xd0, 0x0e, 0x0e, 0x38, 0x86, 0x4d, 0x8a, 0xc5, 0x6f, 0xc0, 0x88, 0x0c, 0x3e, 0xed, 0x84, 0x09, 0x6f, 0x63, 0x8b, 0xd9, 0x1e, 0x7a, 0x78, 0xc6, 0x5b, 0x0b, 0x25, 0x8f, 0xc3, 0xab, 0xbc, 0x34, 0x0f, 0x6a, 0x45, 0x67, 0x14, 0xb3, 0x1f, 0xb9, 0xe2, 0xa6, 0x74, 0xae, 0xaf, 0xe7, 0x0f, 0x3a, 0x26, 0x21, 0xed, 0xce, 0x74, 0xb7, 0xf8},
        {0xfd, 0xba, 0xbe, 0x1c, 0x9d, 0x34, 0x72, 0x00, 0x78, 0x56, 0xe7, 0x19, 0x0d, 0x01, 0xe9, 0xfe, 0x7c, 0x6a, 0xd7, 0xcb, 0xc8, 0x23, 0x78, 0x30, 0xe7, 0x73, 0x76, 0x63, 0x4b, 0x37, 0x31, 0x62, 0x2e, 0xaf, 0x30, 0xd9, 0x2e, 0x22, 0xa3, 0x88, 0x6f, 0xf1, 0x09, 0x27, 0x9d, 0x98, 0x30, 0xda, 0xc7, 0x27, 0xaf, 0xb9, 0x4a, 0x83, 0xee, 0x6d, 0x83, 0x60, 0xcb, 0xdf, 0xa2, 0xcc, 0x06, 0x40},
        {0x70, 0x23, 0xbd, 0xcb, 0x3a, 0xfd, 0x73, 0x48, 0x46, 0x1c, 0x06, 0xcd, 0x81, 0xfd, 0x38, 0xeb, 0xfd, 0xa8, 0xfb, 0xba, 0x90, 0x4f, 0x8e, 0x3e, 0xa9, 0xb5, 0x43, 0xf6, 0x54, 0x5d, 0xa1, 0xf2, 0xd5, 0x43, 0x29, 0x55, 0x61, 0x3f, 0x0f, 0xcf, 0x62, 0xd4, 0x97, 0x05, 0x24, 0x2a, 0x9a, 0xf9, 0xe6, 0x1e, 0x85, 0xdc, 0x0d, 0x65, 0x1e, 0x40, 0xdf, 0xcf, 0x01, 0x7b, 0x45, 0x57, 0x58, 0x87},
        {0x21, 0x01, 0xcb, 0x9b, 0x6a, 0x51, 0x1a, 0xae, 0xad, 0xdb, 0xbe, 0x09, 0xcf, 0x70, 0xf8, 0x81, 0xec, 0x56, 0x8d, 0x57, 0x4a, 0x2f, 0xfd, 0x4d, 0xab, 0xe5, 0xee, 0x98, 0x20, 0xad, 0xaa, 0x47, 0x8e, 0x56, 0xfd, 0x8f, 0x4b, 0xa5, 0xd0, 0x9f, 0xfa, 0x1c, 0x6d, 0x92, 0x7c, 0x40, 0xf4, 0xc3, 0x37, 0x30, 0x40, 0x49, 0xe8, 0xa9, 0x52, 0xfb, 0xcb, 0xf4, 0x5c, 0x6f, 0xa7, 0x7a, 0x41, 0xa4}};

    for (int i = 0; i < 5; ++i) {
        uint8_t *buffer = scrypt(password[i], salt[i], N[i], r[i], p[i], cLen);
        for (int j = 0; j < cLen; ++j) {
            if (buffer[j] != correct_output[i][j]) {
                printf("%02x", buffer[j]);
                return false;
            }
        }
        std::cout << std::endl;
    }
    return true;
}

bool RunTests() {
    std::cout << "Test des fonctions:" << std::endl;
    bool all_tests_correct = true;
    if (TestSalsa20_8()) std::cout << " [-] Salsa20/8 correct." << std::endl;
    else {
        std::cout << " [X] Salsa20/8 incorrect." << std::endl;
        all_tests_correct = false;
    }
    if (TestScryptBlockMix()) std::cout << " [-] ScryptBlockMix correct." << std::endl;
    else {
        std::cout << " [X] ScryptBlockMix incorrect." << std::endl;
        all_tests_correct = false;
    }
    if (TestScryptROMix()) std::cout << " [-] ScryptROMix correct." << std::endl;
    else {
        std::cout << " [X] ScryptROMix incorrect." << std::endl;
        all_tests_correct = false;
    }
    if (TestScrypt()) std::cout << " [-] Scrypt correct." << std::endl;
    else {
        std::cout << " [X] Scrypt incorrect." << std::endl;
        all_tests_correct = false;
    }
    return all_tests_correct;
}

int main(int argc, char const *argv[])
{
    if (!RunTests()) return EXIT_FAILURE;

    std::cout << "==============================" << std::endl;
    std::cout << "Tous les tests ont rÃ©ussi" << std::endl;
    return EXIT_SUCCESS;
}